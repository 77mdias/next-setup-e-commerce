# S01-STR-001 - Introduzir campos Stripe separados no modelo `Order`

**Data:** 2026-02-27  
**Status:** ✅ Concluida

## Resumo

Modelo `Order` foi evoluido para separar IDs de sessao de checkout e payment intent, com estrategia de transicao sem downtime logico.

## Implementacao aplicada

- Inclusao dos campos opcionais `stripeCheckoutSessionId` e `stripePaymentIntentId` em `Order`.
- Inclusao de indices para lookup critico:
  - `(userId, stripeCheckoutSessionId)` para consulta segura por ownership.
  - `(stripePaymentIntentId)` para conciliacao por pagamento.
- Migration `20260227162000_split_stripe_identifiers_order` criada com backfill:
  - Valores legado `stripePaymentId` com prefixo `pi_` migrados para `stripePaymentIntentId`.
  - Demais valores legado migrados para `stripeCheckoutSessionId`.
- Campo legado `stripePaymentId` mantido para compatibilidade temporaria durante rollout.

## Arquivos alterados

- `prisma/schema.prisma`
- `prisma/migrations/20260227162000_split_stripe_identifiers_order/migration.sql`

## Validacoes

- `npx prisma generate` ✅
- `npm run build` ✅

## Riscos residuais

- Backfill legado usa heuristica por prefixo (`pi_` vs demais), portanto pedidos antigos podem nao ter separacao perfeita quando o historico ja perdeu o session ID.
- Remocao do campo legado depende de rollout completo e janela de limpeza posterior.
