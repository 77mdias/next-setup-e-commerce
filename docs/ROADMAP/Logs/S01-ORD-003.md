# S01-ORD-003 - Ajustar paginas de sucesso/falha para estados 401/403/404

**Data:** 2026-02-27  
**Status:** ✅ Concluida

## Resumo

Fluxo de retorno do checkout em `/orders/success` e `/orders/failure` foi endurecido para validacao de ownership por `session_id`, com redirecionamento seguro para login quando nao autenticado e feedback de acesso seguro quando pedido nao esta acessivel.

## Implementacao aplicada

- Criado utilitario compartilhado de order-session:
  - `normalizeOrderSessionId`
  - `buildOrderSessionLookupWhere`
  - `buildOrderSessionCallbackPath`
- `GET /api/orders/session/[sessionId]` passou a reutilizar o utilitario compartilhado, mantendo consistencia de contrato entre backend e paginas.
- `orders/success` agora:
  - valida `session_id`;
  - exige sessao ativa;
  - preserva `session_id` no callback de login;
  - valida ownership antes de redirecionar para `/orders?orderId=<id>`;
  - redireciona para feedback seguro (`forbidden/outage`) em casos nao acessiveis.
- `orders/failure` agora:
  - valida `session_id`;
  - exige sessao ativa;
  - preserva `session_id` no callback de login;
  - valida ownership antes de redirecionar para `/orders?orderId=<id>&checkout=failed`;
  - redireciona para feedback seguro (`forbidden/outage`) quando necessario.

## Arquivos alterados

- `src/lib/order-session.ts` (novo)
- `src/app/api/orders/session/[sessionId]/route.ts`
- `src/app/orders/success/page.tsx`
- `src/app/orders/failure/page.tsx`
- `src/app/api/orders/session/[sessionId]/__tests__/route.integration.test.ts`
- `src/app/orders/__tests__/page.integration.test.ts` (novo)
- `vitest.integration.config.ts`

## Validacoes

- `npm run test:integration -- src/app/orders/__tests__/page.integration.test.ts src/app/api/orders/session/[sessionId]/__tests__/route.integration.test.ts` ✅
- `npm run test:integration` ✅
- `npm run lint` ✅
- `npm run build` ✅

## Riscos residuais

- Endpoint de order-session permanece retornando 404 para owner invalido (anti-enumeracao). O fluxo de UX traduz esse resultado para feedback seguro via `/status`.
- Parametro `checkout=failed` em `/orders` e `/carrinho` ainda nao possui banner dedicado; comportamento atual usa redirecionamento seguro sem erro tecnico bruto.
