# S01-STR-003 - Desativar/restringir `/api/test-stripe` fora de desenvolvimento

**Data:** 2026-02-27  
**Status:** ✅ Concluida

## Resumo

Endpoint de diagnostico Stripe foi restringido para impedir uso publico fora de desenvolvimento local.

## Implementacao aplicada

- `GET /api/test-stripe` agora aplica guarda de ambiente antes de qualquer chamada ao Stripe:
  - `NODE_ENV=production` retorna `404`.
  - Ambientes diferentes de `development` ficam bloqueados por padrao.
  - Fora de dev, habilitacao exige `ENABLE_TEST_STRIPE_ENDPOINT=true` + `X-Internal-Debug-Key` valido + IP de origem em `TEST_STRIPE_ALLOWED_IPS`.
- Em `development`, fluxo de diagnostico continua criando sessao de teste.
- Resposta de erro interna foi simplificada para nao expor detalhes de excecao.
- README atualizado com politica operacional do endpoint.
- Teste de integracao adicionado cobrindo:
  - bloqueio em producao sem criar sessao;
  - funcionamento em desenvolvimento;
  - bloqueio fora de dev quando endpoint nao esta habilitado;
  - exigencia de debug key e allowlist de IP fora de desenvolvimento.

## Arquivos alterados

- `src/app/api/test-stripe/route.ts`
- `src/app/api/test-stripe/__tests__/route.integration.test.ts`
- `README.md`
- `docs/development/tasks/PHASE-01-fundacao-seguranca.md`
- `docs/03-seguranca-governanca/01-hardening-backlog.md`

## Validacoes

- `npm run test:integration -- src/app/api/test-stripe/__tests__/route.integration.test.ts` ✅
- `npm run lint` ✅
- `npm run build` ✅

## Riscos residuais

- Endpoint segue existente apenas para diagnostico, mas com defesa em camadas para uso excepcional fora de desenvolvimento.
- Operacao fora de dev requer configuracao explicita de tres controles (`ENABLE_TEST_STRIPE_ENDPOINT`, `INTERNAL_DEBUG_KEY`, `TEST_STRIPE_ALLOWED_IPS`).
