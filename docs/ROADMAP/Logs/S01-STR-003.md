# S01-STR-003 - Desativar/restringir `/api/test-stripe` fora de desenvolvimento

**Data:** 2026-02-27  
**Status:** ✅ Concluida

## Resumo

Endpoint de diagnostico Stripe foi restringido para impedir uso publico fora de desenvolvimento local.

## Implementacao aplicada

- `GET /api/test-stripe` agora aplica guarda de ambiente antes de qualquer chamada ao Stripe:
  - `NODE_ENV=production` retorna `404`.
  - Ambientes diferentes de `development` exigem `X-Internal-Debug-Key` igual a `INTERNAL_DEBUG_KEY`; caso contrario retorna `404`.
- Em `development`, fluxo de diagnostico continua criando sessao de teste.
- Resposta de erro interna foi simplificada para nao expor detalhes de excecao.
- README atualizado com politica operacional do endpoint.
- Teste de integracao adicionado cobrindo:
  - bloqueio em producao sem criar sessao;
  - funcionamento em desenvolvimento;
  - exigencia de debug key fora de desenvolvimento.

## Arquivos alterados

- `src/app/api/test-stripe/route.ts`
- `src/app/api/test-stripe/__tests__/route.integration.test.ts`
- `README.md`
- `docs/development/tasks/PHASE-01-fundacao-seguranca.md`
- `docs/03-seguranca-governanca/01-hardening-backlog.md`

## Validacoes

- `npm run test:integration -- src/app/api/test-stripe/__tests__/route.integration.test.ts` ✅
- `npm run lint` ✅
- `npm run build` ✅

## Riscos residuais

- Ambientes nao-prod com `NODE_ENV` diferente de `development` precisam configurar `INTERNAL_DEBUG_KEY` para uso autorizado.
- Endpoint segue existindo para diagnostico; recomendacao operacional e limitar acesso de rede em ambientes compartilhados.
